name: Build all packages
 
on:
  workflow_dispatch:
    inputs:
      force-all:
        description: "Build all"
        required: false
        type: 'boolean'
        default: 'false'
      force-apps:
        description: "Build all apps"
        required: false
        type: 'boolean'
        default: 'false'
      force-libs:
        description: "Build all libs"
        required: false
        type: 'boolean'
        default: 'false'
      force-py3-paho-mqtt2:
        description: "Build py3-paho-mqtt2"
        required: false
        type: 'boolean'
        default: 'false'
      force-psec-alpine-iso:
        description: "Build alpine-iso"
        required: false
        type: 'boolean'
        default: 'false'
      force-psec-alpine-virt:
        description: "Build alpine-virt"
        required: false
        type: 'boolean'
        default: 'false'
      force-psec-container-debian:
        description: "Build container-debian"
        required: false
        type: 'boolean'
        default: 'false'
      force-psec-core:
        description: "Build core"
        required: false
        type: 'boolean'
        default: 'false'
      force-psec-demo:
        description: "Build demo"
        required: false
        type: 'boolean'
        default: 'false'
      force-psec-demo-gui:
        description: "Build demo-gui"
        required: false
        type: 'boolean'
        default: 'false'
      force-psec-diag:
        description: "Build diag"
        required: false
        type: 'boolean'
        default: 'false'
      force-psec-tests:
        description: "Build tests"
        required: false
        type: 'boolean'
        default: 'false'
      force-psec-gui-base:
        description: "Build gui-base"
        required: false
        type: 'boolean'
        default: 'false'
      force-psec-lib:
        description: "Build lib"
        required: false
        type: 'boolean'
        default: 'false'
      force-psec-sys-gui:
        description: "Build sys-gui"
        required: false
        type: 'boolean'
        default: 'false'
      force-psec-sys-usb:
        description: "Build sys-usb"
        required: false
        type: 'boolean'
        default: 'false'      
  push:
    branches:
      - "**"
    paths:
      - "setup/packages/psec/**"
      - "python/**"

jobs:  
  detect-changes:
    name: Detect changed packages
    runs-on: ubuntu-latest
    outputs:
      pkg-py3-paho-mqtt2: ${{ steps.detect.outputs.py3-paho-mqtt2 }}
      pkg-psec-alpine-iso: ${{ steps.detect.outputs.psec-alpine-iso }}
      pkg-psec-alpine-virt: ${{ steps.detect.outputs.psec-alpine-virt }}
      pkg-psec-container-debian: ${{ steps.detect.outputs.psec-container-debian }}
      pkg-psec-core: ${{ steps.detect.outputs.psec-core }}
      pkg-psec-demo: ${{ steps.detect.outputs.psec-demo }}
      pkg-psec-demo-gui: ${{ steps.detect.outputs.psec-demo-gui }}
      pkg-psec-diag: ${{ steps.detect.outputs.psec-diag }}
      pkg-psec-gui-base: ${{ steps.detect.outputs.psec-gui-base }}
      pkg-psec-lib: ${{ steps.detect.outputs.psec-lib }}
      pkg-psec-sys-gui: ${{ steps.detect.outputs.psec-sys-gui }}
      pkg-psec-sys-usb: ${{ steps.detect.outputs.psec-sys-usb }}
      app-demo: ${{ steps.detect.outputs.app-demo }}
      app-demo2: ${{ steps.detect.outputs.app-demo2 }}
      app-diag: ${{ steps.detect.outputs.app-diag }}
      app-lib: ${{ steps.detect.outputs.app-lib }}
      app-tests: ${{ steps.detect.outputs.app-tests }}
            
    steps:
      - uses: actions/checkout@v4
      - name: Detect changed components
        id: detect
        run: |
          echo "Detecting changes..."
          declare -A paths=(
            [py3-paho-mqtt2]="setup/packages/psec/py3-paho-mqtt2/"
            [psec-alpine-iso]="setup/packages/psec/py3-paho-mqtt2/"
            [psec-alpine-virt]="setup/packages/psec/py3-paho-mqtt2/"
            [psec-container-debian]="setup/packages/psec/py3-paho-mqtt2/"
            [psec-core]="setup/packages/psec/psec-core/"
            [psec-demo]="setup/packages/psec/psec-demo/"
            [psec-demo-gui]="setup/packages/psec/psec-demo-gui/"
            [psec-diag]="setup/packages/psec/psec-diag/"
            [psec-gui-base]="setup/packages/psec/psec-gui-base/"
            [psec-lib]="setup/packages/psec/psec-lib/"
            [psec-sys-gui]="setup/packages/psec/psec-sys-gui/"
            [psec-sys-usb]="setup/packages/psec/psec-sys-usb/"
            [app-diag]="python/diag/"
            [app-demo]="python/demo/"
            [app-demo2]="python/demo2/"
            [app-lib]="python/lib/"
            [app-tests]="python/tests/"
          )

          for key in "${!paths[@]}"; do
            if git diff --name-only ${{ github.event.before }} ${{ github.sha }} \
              | grep "^${paths[$key]}"; then
              echo "$key=true" >> $GITHUB_OUTPUT
            else
              echo "$key=false" >> $GITHUB_OUTPUT
            fi
          done

  prepare:
    runs-on: ubuntu-latest
    needs: detect-changes
    outputs:
      check-py3-paho-mqtt2: ${{ steps.check-py3-paho-mqtt2.outputs.do_build }}
      check-psec-lib: ${{ steps.check-psec-lib.outputs.do_build }}
      check-psec-alpine-virt: ${{ steps.check-psec-alpine-virt.outputs.do_build }}
      check-psec-alpine-iso: ${{ steps.check-psec-alpine-iso.outputs.do_build }}
      check-psec-container-debian: ${{ steps.check-psec-container-debian.outputs.do_build }}
      check-psec-core: ${{ steps.check-psec-core.outputs.do_build }}
      check-psec-sys-gui: ${{ steps.check-psec-sys-gui.outputs.do_build }}
      check-psec-sys-usb: ${{ steps.check-psec-sys-usb.outputs.do_build }}
      check-psec-gui-base: ${{ steps.check-psec-gui-base.outputs.do_build }}
      check-app-tests: ${{ steps.check-app-tests.outputs.do_build }}
      check-app-diag: ${{ steps.check-app-diag.outputs.do_build }}
      check-app-demo: ${{ steps.check-app-demo.outputs.do_build }}      
    steps:
      - id: check-py3-paho-mqtt2 
        name: check-py3-paho-mqtt2 
        env:
          PKG_CHANGED: ${{ needs.detect-changes.outputs.pkg-py3-paho-mqtt2 }}
          FORCE: ${{ github.event.inputs.force-py3-paho-mqtt2 }}
          FORCE_ALL: ${{ github.event.inputs.force-all }}
          FORCE_APPS: ${{ github.event.inputs.force-apps }}
          FORCE_LIBS: ${{ github.event.inputs.force-libs }}
        run: |          
          if [[ $PKG_CHANGED == 'true' || $FORCE == 'true' || $FORCE_ALL == 'true' || $FORCE_APPS == 'true' || $FORCE_LIBS == 'true' ]]; then 
            echo "do_build=true" >> $GITHUB_OUTPUT
          else 
            echo "do_build=false" >> $GITHUB_OUTPUT
          fi
      - id: check-psec-lib
        name: check-psec-lib
        env:
          PKG_CHANGED: ${{ needs.detect-changes.outputs.pkg-psec-lib }}
          FORCE: ${{ github.event.inputs.force-psec-lib }}
          FORCE_ALL: ${{ github.event.inputs.force-all }}
          FORCE_APPS: ${{ github.event.inputs.force-apps }}
          FORCE_LIBS: ${{ github.event.inputs.force-libs }}
        run: |          
          if [[ $PKG_CHANGED == 'true' || $FORCE == 'true' || $FORCE_ALL == 'true' || $FORCE_APPS == 'true' || $FORCE_LIBS == 'true' ]]; then 
            echo "do_build=true" >> $GITHUB_OUTPUT
          else 
            echo "do_build=false" >> $GITHUB_OUTPUT
          fi
      - id: check-psec-alpine-virt
        name: check-psec-alpine-virt
        env:
          PKG_CHANGED: ${{ needs.detect-changes.outputs.pkg-psec-alpine-virt }}
          FORCE: ${{ github.event.inputs.force-psec-alpine-virt }}
          FORCE_ALL: ${{ github.event.inputs.force-all }}
          FORCE_APPS: ${{ github.event.inputs.force-apps }}
          FORCE_LIBS: ${{ github.event.inputs.force-libs }}
        run: |          
          if [[ $PKG_CHANGED == 'true' || $FORCE == 'true' || $FORCE_ALL == 'true' ]]; then 
            echo "do_build=true" >> $GITHUB_OUTPUT
          else 
            echo "do_build=false" >> $GITHUB_OUTPUT
          fi
      - id: check-psec-alpine-iso
        name: check-psec-alpine-iso
        env:
          PKG_CHANGED: ${{ needs.detect-changes.outputs.pkg-psec-alpine-iso }}
          FORCE: ${{ github.event.inputs.force-psec-alpine-iso }}
          FORCE_ALL: ${{ github.event.inputs.force-all }}
          FORCE_APPS: ${{ github.event.inputs.force-apps }}
          FORCE_LIBS: ${{ github.event.inputs.force-libs }}
        run: |          
          if [[ $PKG_CHANGED == 'true' || $FORCE == 'true' || $FORCE_ALL == 'true' ]]; then 
            echo "do_build=true" >> $GITHUB_OUTPUT
          else 
            echo "do_build=false" >> $GITHUB_OUTPUT
          fi
      - id: check-psec-container-debian
        name: check-psec-container-debian
        env:
          PKG_CHANGED: ${{ needs.detect-changes.outputs.pkg-psec-container-debian }}
          FORCE: ${{ github.event.inputs.force-psec-container-debian }}
          FORCE_ALL: ${{ github.event.inputs.force-all }}
          FORCE_APPS: ${{ github.event.inputs.force-apps }}
          FORCE_LIBS: ${{ github.event.inputs.force-libs }}
        run: |          
          if [[ $PKG_CHANGED == 'true' || $FORCE == 'true' || $FORCE_ALL == 'true' ]]; then 
            echo "do_build=true" >> $GITHUB_OUTPUT
          else 
            echo "do_build=false" >> $GITHUB_OUTPUT
          fi
      - id: check-psec-core
        name: check-psec-core
        env:
          PKG_CHANGED: ${{ needs.detect-changes.outputs.pkg-psec-core }}
          FORCE: ${{ github.event.inputs.force-psec-core }}
          FORCE_ALL: ${{ github.event.inputs.force-all }}
          FORCE_APPS: ${{ github.event.inputs.force-apps }}
          FORCE_LIBS: ${{ github.event.inputs.force-libs }}
        run: |          
          if [[ $PKG_CHANGED == 'true' || $FORCE == 'true' || $FORCE_ALL == 'true' || $FORCE_APPS == 'true' ]]; then 
            echo "do_build=true" >> $GITHUB_OUTPUT
          else 
            echo "do_build=false" >> $GITHUB_OUTPUT
          fi
      - id: check-psec-sys-gui
        name: check-psec-sys-gui
        env:
          PKG_CHANGED: ${{ needs.detect-changes.outputs.pkg-psec-sys-gui }}
          FORCE: ${{ github.event.inputs.force-psec-sys-gui }}
          FORCE_ALL: ${{ github.event.inputs.force-all }}
          FORCE_APPS: ${{ github.event.inputs.force-apps }}
          FORCE_LIBS: ${{ github.event.inputs.force-libs }}
        run: |          
          if [[ $PKG_CHANGED == 'true' || $FORCE == 'true' || $FORCE_ALL == 'true' || $FORCE_APPS == 'true' ]]; then 
            echo "do_build=true" >> $GITHUB_OUTPUT
          else 
            echo "do_build=false" >> $GITHUB_OUTPUT
          fi
      - id: check-psec-sys-usb
        name: check-psec-sys-usb
        env:
          PKG_CHANGED: ${{ needs.detect-changes.outputs.pkg-psec-sys-usb }}
          FORCE: ${{ github.event.inputs.force-psec-sys-usb }}
          FORCE_ALL: ${{ github.event.inputs.force-all }}
          FORCE_APPS: ${{ github.event.inputs.force-apps }}
          FORCE_LIBS: ${{ github.event.inputs.force-libs }}
        run: |          
          if [[ $PKG_CHANGED == 'true' || $FORCE == 'true' || $FORCE_ALL == 'true' || $FORCE_APPS == 'true' ]]; then 
            echo "do_build=true" >> $GITHUB_OUTPUT
          else 
            echo "do_build=false" >> $GITHUB_OUTPUT
          fi
      - id: check-psec-gui-base
        name: check-psec-gui-base
        env:
          PKG_CHANGED: ${{ needs.detect-changes.outputs.pkg-psec-gui-base }}
          FORCE: ${{ github.event.inputs.force-psec-gui-base }}
          FORCE_ALL: ${{ github.event.inputs.force-all }}
          FORCE_APPS: ${{ github.event.inputs.force-apps }}
          FORCE_LIBS: ${{ github.event.inputs.force-libs }}
        run: |          
          if [[ $PKG_CHANGED == 'true' || $FORCE == 'true' || $FORCE_ALL == 'true' || $FORCE_APPS == 'true' ]]; then 
            echo "do_build=true" >> $GITHUB_OUTPUT
          else 
            echo "do_build=false" >> $GITHUB_OUTPUT
          fi
      - id: check-app-tests
        name: check-app-tests
        env:
          PKG_CHANGED: ${{ needs.detect-changes.outputs.pkg-app-tests }}
          FORCE: ${{ github.event.inputs.force-psec-tests }}
          FORCE_ALL: ${{ github.event.inputs.force-all }}
          FORCE_APPS: ${{ github.event.inputs.force-apps }}
          FORCE_LIBS: ${{ github.event.inputs.force-libs }}
        run: |          
          if [[ $PKG_CHANGED == 'true' || $FORCE == 'true' || $FORCE_ALL == 'true' || $FORCE_APPS == 'true' ]]; then 
            echo "do_build=true" >> $GITHUB_OUTPUT
          else 
            echo "do_build=false" >> $GITHUB_OUTPUT
          fi
      - id: check-app-diag
        name: check-app-diag
        env:
          PKG_CHANGED: ${{ needs.detect-changes.outputs.pkg-app-diag }}
          FORCE: ${{ github.event.inputs.force-psec-diag }}
          FORCE_ALL: ${{ github.event.inputs.force-all }}
          FORCE_APPS: ${{ github.event.inputs.force-apps }}
          FORCE_LIBS: ${{ github.event.inputs.force-libs }}
        run: |          
          if [[ $PKG_CHANGED == 'true' || $FORCE == 'true' || $FORCE_ALL == 'true' || $FORCE_APPS == 'true' ]]; then 
            echo "do_build=true" >> $GITHUB_OUTPUT
          else 
            echo "do_build=false" >> $GITHUB_OUTPUT
          fi
      - id: check-app-demo
        name: check-app-demo
        env:
          PKG_CHANGED: ${{ needs.detect-changes.outputs.pkg-app-demo }}
          FORCE: ${{ github.event.inputs.force-psec-demo }}
          FORCE_ALL: ${{ github.event.inputs.force-all }}
          FORCE_APPS: ${{ github.event.inputs.force-apps }}
          FORCE_LIBS: ${{ github.event.inputs.force-libs }}
        run: |          
          if [[ $PKG_CHANGED == 'true' || $FORCE == 'true' || $FORCE_ALL == 'true' || $FORCE_APPS == 'true' ]]; then 
            echo "do_build=true" >> $GITHUB_OUTPUT
          else 
            echo "do_build=false" >> $GITHUB_OUTPUT
          fi

  build-py3-paho-mqtt2:
    needs: [ prepare ]
    if: |
      needs.prepare.outputs.check-py3-paho-mqtt2 == 'true' || 
      needs.prepare.outputs.check-psec-lib == 'true' ||
      needs.prepare.outputs.check-psec-core == 'true' ||
      needs.prepare.outputs.check-psec-sys-gui == 'true' ||
      needs.prepare.outputs.check-psec-sys-usb == 'true'
    runs-on: ubuntu-latest
 
    container:
      image: alpine:3.21
 
    steps:      
      - name: Checkout sources
        uses: actions/checkout@v4
 
      - name: Prepare build environment
        uses: ./.github/actions/prepare-build-env
        with:
          abuild-key: ${{ secrets.ABUILD_PRIVATE_KEY }}
 
      - name: Build APK
        uses: ./.github/actions/build-apk
        with:
          working-dir: setup/packages/psec/py3-paho-mqtt2
          artifact-name: py3-paho-mqtt2

      - name: Publish package
        uses: ./.github/actions/publish
        with:
          privkey: ${{ secrets.DEPLOY_KEY }}
          filepath: /home/builder/packages/psec/x86_64/
          
  build-psec-lib:
    needs: [ prepare, build-py3-paho-mqtt2 ]
    if: | 
      needs.prepare.outputs.check-psec-lib == 'true' ||
      needs.prepare.outputs.check-psec-core == 'true' ||
      needs.prepare.outputs.check-psec-sys-gui == 'true' ||
      needs.prepare.outputs.check-psec-sys-usb == 'true'
    runs-on: ubuntu-latest
 
    container:
      image: alpine:3.21
 
    steps:      
      - name: Checkout sources
        uses: actions/checkout@v4
 
      - name: Prepare build environment
        uses: ./.github/actions/prepare-build-env
        with:
          abuild-key: ${{ secrets.ABUILD_PRIVATE_KEY }}
 
      - name: Get py3-paho-mqtt2 dependency
        uses: ./.github/actions/get-dependency
        with:
          name: py3-paho-mqtt2
 
      - name: Build APK
        uses: ./.github/actions/build-apk
        with:
          working-dir: setup/packages/psec/psec-lib
          artifact-name: psec-lib

      - name: Publish package
        uses: ./.github/actions/publish
        with:
          privkey: ${{ secrets.DEPLOY_KEY }}
          filepath: /home/builder/packages/psec/x86_64/

  build-alpine-virt:
    needs: [ prepare ]
    if: | 
      needs.prepare.outputs.check-psec-alpine-virt == 'true' ||
      needs.prepare.outputs.check-psec-sys-gui == 'true' ||
      needs.prepare.outputs.check-psec-sys-usb == 'true'
    runs-on: ubuntu-latest
 
    container:
      image: alpine:3.21
 
    steps:      
      - name: Checkout sources
        uses: actions/checkout@v4
 
      - name: Prepare build environment
        uses: ./.github/actions/prepare-build-env
        with:
          abuild-key: ${{ secrets.ABUILD_PRIVATE_KEY }}
 
      - name: Build APK
        uses: ./.github/actions/build-apk
        with:
          working-dir: setup/packages/psec/psec-alpine-virt
          artifact-name: psec-alpine-virt

      - name: Publish package
        uses: ./.github/actions/publish
        with:
          privkey: ${{ secrets.DEPLOY_KEY }}
          filepath: /home/builder/packages/psec/x86_64/

  build-alpine-iso:
    needs: [ prepare ]
    if: | 
      needs.prepare.outputs.check-psec-alpine-iso == 'true'
    runs-on: ubuntu-latest
 
    container:
      image: alpine:3.21
 
    steps:      
      - name: Checkout sources
        uses: actions/checkout@v4
 
      - name: Prepare build environment
        uses: ./.github/actions/prepare-build-env
        with:
          abuild-key: ${{ secrets.ABUILD_PRIVATE_KEY }}
 
      - name: Build APK
        uses: ./.github/actions/build-apk
        with:
          working-dir: setup/packages/psec/psec-alpine-iso
          artifact-name: psec-alpine-iso

      - name: Publish package
        uses: ./.github/actions/publish
        with:
          privkey: ${{ secrets.DEPLOY_KEY }}
          filepath: /home/builder/packages/psec/x86_64/  

  build-lxc-container-debian:
    needs: [ prepare ]
    if: | 
      needs.prepare.outputs.check-psec-container-debian == 'true'
    runs-on: ubuntu-latest
 
    steps:
      - name: Checkout sources 
        uses: actions/checkout@v4

      - name: Install dependencies
        shell: sh
        run: |
          sudo apt update
          sudo apt install lxc lxc-templates liblxc-common iptables

      - name: Create generic Debian container 
        env:
          pkgname: lxc-container-debian
          srcdir: ${{ github.workspace }}/src
          distro: debian
          release: bookworm
          arch: amd64
          variant: cloud
        shell: sh         
        run: |
          # Create the container 
          sudo lxc-create -n "$pkgname" -t download -P "$srcdir" -- --dist $distro --release $release --arch $arch --variant $variant
          
          # Remove network configuration
          sudo sed -i 's/^lxc\.net/#&/' "$srcdir/$pkgname"/config
          
          # Stop the container
          # sudo lxc-stop "$pkgname"

          # Create an archive
          echo Compressing the image...
          sudo tar cjf "$pkgname".tar.bz2 -C "$srcdir" .
          echo Compression finished

          # Compress archive
          # sudo bzip2 "$pkgname".tar

      - name: Publish archive
        uses: ./.github/actions/publish
        with:
          privkey: ${{ secrets.DEPLOY_KEY }}
          filepath: lxc-container-debian.tar.bz2
          container: false

  build-container-debian:
    needs: [ prepare ]
    if: | 
      needs.prepare.outputs.check-psec-container-debian == 'true'
    runs-on: ubuntu-latest
 
    container:
      image: alpine:3.21
 
    steps:      
      - name: Checkout sources
        uses: actions/checkout@v4
 
      - name: Prepare build environment
        uses: ./.github/actions/prepare-build-env
        with:
          abuild-key: ${{ secrets.ABUILD_PRIVATE_KEY }}
 
      - name: Build APK
        uses: ./.github/actions/build-apk
        with:
          working-dir: setup/packages/psec/psec-container-debian
          artifact-name: psec-container-debian

      - name: Publish package
        uses: ./.github/actions/publish
        with:
          privkey: ${{ secrets.DEPLOY_KEY }}
          filepath: /home/builder/packages/psec/x86_64/

  build-psec-core:
    needs: [ prepare, build-psec-lib ]
    if: needs.prepare.outputs.check-psec-core == 'true'        
    runs-on: ubuntu-latest
 
    container:
      image: alpine:3.21
 
    steps:      
      - name: Checkout sources
        uses: actions/checkout@v4
 
      - name: Prepare build environment
        uses: ./.github/actions/prepare-build-env
        with:
          abuild-key: ${{ secrets.ABUILD_PRIVATE_KEY }}
 
      - name: Get psec-lib dependency
        uses: ./.github/actions/get-dependency
        with:
          name: psec-lib         
 
      - name: Build APK
        uses: ./.github/actions/build-apk
        with:
          working-dir: setup/packages/psec/psec-core
          artifact-name: psec-core

      - name: Publish package
        uses: ./.github/actions/publish
        with:
          privkey: ${{ secrets.DEPLOY_KEY }}
          filepath: /home/builder/packages/psec/x86_64/

  build-psec-sys-gui:
    needs: [ prepare, build-psec-lib ]
    if: needs.prepare.outputs.check-psec-sys-gui == 'true'
    runs-on: ubuntu-latest
 
    container:
      image: alpine:3.21
 
    steps:      
      - name: Checkout sources
        uses: actions/checkout@v4
 
      - name: Prepare build environment
        uses: ./.github/actions/prepare-build-env
        with:
          abuild-key: ${{ secrets.ABUILD_PRIVATE_KEY }}
 
      - name: Get psec-lib dependency
        uses: ./.github/actions/get-dependency
        with:
          name: psec-lib         
 
      - name: Build APK
        uses: ./.github/actions/build-apk
        with:
          working-dir: setup/packages/psec/psec-sys-gui
          artifact-name: psec-sys-gui

      - name: Publish package
        uses: ./.github/actions/publish
        with:
          privkey: ${{ secrets.DEPLOY_KEY }}
          filepath: /home/builder/packages/psec/x86_64/

  build-psec-sys-usb:
    needs: [ prepare, build-psec-lib ]
    if: needs.prepare.outputs.check-psec-sys-usb == 'true'
    runs-on: ubuntu-latest
 
    container:
      image: alpine:3.21
 
    steps:      
      - name: Checkout sources
        uses: actions/checkout@v4
 
      - name: Prepare build environment
        uses: ./.github/actions/prepare-build-env
        with:
          abuild-key: ${{ secrets.ABUILD_PRIVATE_KEY }}
 
      - name: Get psec-lib dependency
        uses: ./.github/actions/get-dependency
        with:
          name: psec-lib         
 
      - name: Build APK
        uses: ./.github/actions/build-apk
        with:
          working-dir: setup/packages/psec/psec-sys-usb
          artifact-name: psec-sys-usb

      - name: Publish package
        uses: ./.github/actions/publish
        with:
          privkey: ${{ secrets.DEPLOY_KEY }}
          filepath: /home/builder/packages/psec/x86_64/

  build-psec-gui-base:
    needs: [ prepare, build-psec-lib ]
    if: needs.prepare.outputs.check-psec-gui-base == 'true'
    runs-on: ubuntu-latest
 
    container:
      image: alpine:3.21
 
    steps:      
      - name: Checkout sources
        uses: actions/checkout@v4
 
      - name: Prepare build environment
        uses: ./.github/actions/prepare-build-env
        with:
          abuild-key: ${{ secrets.ABUILD_PRIVATE_KEY }}     
 
      - name: Build APK
        uses: ./.github/actions/build-apk
        with:
          working-dir: setup/packages/psec/psec-gui-base
          artifact-name: psec-gui-base

      - name: Publish package
        uses: ./.github/actions/publish
        with:
          privkey: ${{ secrets.DEPLOY_KEY }}
          filepath: /home/builder/packages/psec/x86_64/

  build-app-tests:
    needs: [ prepare, build-psec-lib, build-psec-core, build-psec-sys-gui ]
    if: needs.prepare.outputs.check-app-tests == 'true'
    runs-on: ubuntu-latest
 
    container:
      image: alpine:3.21
 
    steps:      
      - name: Checkout sources
        uses: actions/checkout@v4
 
      - name: Prepare build environment
        uses: ./.github/actions/prepare-build-env
        with:
          abuild-key: ${{ secrets.ABUILD_PRIVATE_KEY }}     
 
      - name: Get psec-lib dependency
        uses: ./.github/actions/get-dependency
        with:
          name: psec-lib

      - name: Get psec-core dependency
        uses: ./.github/actions/get-dependency
        with:
          name: psec-core

      - name: Build APK
        uses: ./.github/actions/build-apk
        with:
          working-dir: setup/packages/psec/psec-tests-gui
          artifact-name: psec-tests-gui

      - name: Build APK
        uses: ./.github/actions/build-apk
        with:
          working-dir: setup/packages/psec/psec-tests
          artifact-name: psec-tests

      - name: Publish package
        uses: ./.github/actions/publish
        with:
          privkey: ${{ secrets.DEPLOY_KEY }}
          filepath: /home/builder/packages/psec/x86_64/

  build-app-diag:
    needs: [ prepare ]
    if: needs.prepare.outputs.check-app-diag == 'true'
    runs-on: ubuntu-latest
 
    container:
      image: alpine:3.21
 
    steps:      
      - name: Checkout sources
        uses: actions/checkout@v4
 
      - name: Prepare build environment
        uses: ./.github/actions/prepare-build-env
        with:
          abuild-key: ${{ secrets.ABUILD_PRIVATE_KEY }}

      - name: Build APK
        uses: ./.github/actions/build-apk
        with:
          working-dir: setup/packages/psec/psec-diag
          artifact-name: psec-diag

      - name: Publish package
        uses: ./.github/actions/publish
        with:
          privkey: ${{ secrets.DEPLOY_KEY }}
          filepath: /home/builder/packages/psec/x86_64/

  build-app-demo:
    needs: [ prepare, build-psec-lib, build-psec-core, build-psec-sys-gui ]
    if: needs.prepare.outputs.check-app-demo == 'true'
    runs-on: ubuntu-latest
 
    container:
      image: alpine:3.21
 
    steps:      
      - name: Checkout sources
        uses: actions/checkout@v4
 
      - name: Prepare build environment
        uses: ./.github/actions/prepare-build-env
        with:
          abuild-key: ${{ secrets.ABUILD_PRIVATE_KEY }}     
 
      - name: Get psec-lib dependency
        uses: ./.github/actions/get-dependency
        with:
          name: psec-lib

      - name: Get psec-core dependency
        uses: ./.github/actions/get-dependency
        with:
          name: psec-core

      - name: Build APK
        uses: ./.github/actions/build-apk
        with:
          working-dir: setup/packages/psec/psec-demo-gui
          artifact-name: psec-demo-gui

      - name: Build APK
        uses: ./.github/actions/build-apk
        with:
          working-dir: setup/packages/psec/psec-demo
          artifact-name: psec-demo

      - name: Publish package
        uses: ./.github/actions/publish
        with:
          privkey: ${{ secrets.DEPLOY_KEY }}
          filepath: /home/builder/packages/psec/x86_64/
