# Contributor:
# Maintainer: Tristan IsraÃ«l <tristan.israel@alefbet.net>
pkgname=psec-container-debian
pkgver=1.0
pkgrel=1
pkgdesc="PSEC - LXC Container based on Debian"
url="https://www.alefbet.net/"
arch="x86_64"
license="MIT"
#depends="lxc lxc-download lxc-templates lxc-bridge iptables"
makedepends="debootstrap"
builddir="$srcdir/$pkgname-$pkgver"
checkdepends=""
install="$pkgname.post-install $pkgname.pre-deinstall"
subpackages=""
replaces=""
options="!check"  # no tests provided
_release="trixie"
_variant="minbase"
#_arch="amd64"
source="
config
"
#https://www.alefbet.net/github/psec/x86_64/lxc-container-debian.tar.bz2

#build() {     
    # The container has been previously created
    # Create a new container
    # sudo lxc-create -n "$pkgname" -t download -P "$srcdir" -- --dist $_distro --release $_release --arch $_arch

    # Disable networking in the container
    # sudo sed -i 's/^lxc\.net/#&/' "$srcdir/$pkgname"/config

    # sudo lxc-stop "$pkgname"
#}

prepare() {
    default_prepare
}

build() {
    mkdir -p "$builddir"/psec-container-debian/rootfs
    cp "$srcdir"/config "$builddir"/psec-container-debian

    echo "Create a rootfs with debootstrap"
    echo "Release: $_release. Variant= $_variant"
    sudo debootstrap --variant=$_variant $_release $builddir/psec-container-debian/rootfs http://deb.debian.org/debian/
    #sudo mount -t proc /proc "$builddir"/psec-container-debian/rootfs/proc
    #sudo mount --rbind /sys "$builddir"/psec-container-debian/rootfs/sys
    #sudo mount --rbind /dev "$builddir"/psec-container-debian/rootfs/dev
    sudo chroot "$builddir"/psec-container-debian/rootfs apt-get update
    sudo chroot "$builddir"/psec-container-debian/rootfs apt-get install -y systemd systemd-sysv dbus 
    # To remove if not necessary in the product container
    sudo chroot "$builddir"/psec-container-debian/rootfs apt-get install -y isc-dhcp-client iproute2 iputils-ping dnsutils
    #sudo umount -f "$builddir"/psec-container-debian/rootfs/proc || true
    #sudo umount -f "$builddir"/psec-container-debian/rootfs/sys || true
    #sudo umount -f "$builddir"/psec-container-debian/rootfs/dev || true

    echo "Clean the container"
    sudo chroot "$builddir"/psec-container-debian/rootfs apt-get clean
    sudo chroot "$builddir"/psec-container-debian/rootfs apt-get autoremove --purge -y
    sudo chroot "$builddir"/psec-container-debian/rootfs apt-get autoclean
    sudo rm -rf "$builddir"/psec-container-debian/rootfs/tmp/*
    sudo rm -rf "$builddir"/psec-container-debian/rootfs/var/tmp/*
    sudo rm -rf "$builddir"/psec-container-debian/rootfs/usr/share/doc/*
    sudo rm -rf "$builddir"/psec-container-debian/rootfs/usr/share/man/*
    sudo rm -rf "$builddir"/psec-container-debian/rootfs/usr/share/info/*
    sudo rm -rf "$builddir"/psec-container-debian/rootfs/usr/share/locale/*

    echo "Current rootfs size:"
    sudo du -sk "$builddir"/psec-container-debian/rootfs

    echo "Create an archive"
    sudo tar cjf "$srcdir/$pkgname".tar.bz2 -C "$builddir"/psec-container-debian --exclude "rootfs/sys" --exclude "rootfs/proc" --exclude "rootfs/dev" .
    echo "Archive size:"
    ls -l "$srcdir/$pkgname".tar.bz2

    # Change permission for future cleaning
    sudo chmod -R 777 "$srcdir"/*
}

package() {    
    # Tar container
    echo "Create the package"
    install -D -m644 "$srcdir/$pkgname".tar.bz2 "$pkgdir"/var/lib/lxc/"$pkgname".tar.bz2
}
