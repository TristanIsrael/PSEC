# Contributor:
# Maintainer: Tristan IsraÃ«l <tristan.israel@alefbet.net>
pkgname=psec-container-debian
pkgver=1.0
pkgrel=1
pkgdesc="PSEC - LXC Container based on Debian"
url="https://www.alefbet.net/"
arch="x86_64"
license="MIT"
#depends="lxc lxc-download lxc-templates lxc-bridge iptables"
makedepends="debootstrap"
builddir="$srcdir/$pkgname-$pkgver"
checkdepends=""
install="$pkgname.post-install $pkgname.pre-deinstall"
subpackages=""
replaces=""
options="!check"  # no tests provided
_release="trixie"
_variant="minbase"
#_arch="amd64"
source="
config
"
#https://www.alefbet.net/github/psec/x86_64/lxc-container-debian.tar.bz2

#build() {     
    # The container has been previously created
    # Create a new container
    # sudo lxc-create -n "$pkgname" -t download -P "$srcdir" -- --dist $_distro --release $_release --arch $_arch

    # Disable networking in the container
    # sudo sed -i 's/^lxc\.net/#&/' "$srcdir/$pkgname"/config

    # sudo lxc-stop "$pkgname"
#}

prepare() {
    default_prepare
}

build() {
    mkdir -p "$builddir"/psec-container-debian/rootfs
    cp "$srcdir"/config "$builddir"/psec-container-debian

    echo "Create a rootfs"
    debootstrap --variant=$_variant $_release $builddir/rootfs http://deb.debian.org/debian/
    mount -t proc /proc "$builddir"/psec-container-debian/rootfs/proc
    mount --rbind /sys "$builddir"/psec-container-debian/rootfs/sys
    mount --rbind /dev "$builddir"/psec-container-debian/rootfs/dev
    chroot "$builddir"/psec-container-debian/rootfs apt-get update
    chroot "$builddir"/psec-container-debian/rootfs apt-get install -y systemd systemd-sysv dbus 
    # To remove if not necessary in the product container
    chroot "$builddir"/psec-container-debian/rootfs apt-get install -y isc-dhcp-client iproute2 iputils-ping dnsutils
    umount -f "$builddir"/psec-container-debian/rootfs/proc || true
    umount -f "$builddir"/psec-container-debian/rootfs/sys || true
    umount -f "$builddir"/psec-container-debian/rootfs/dev || true

    echo "Clean the container"
    chroot "$builddir"/psec-container-debian/rootfs apt-get clean
    chroot "$builddir"/psec-container-debian/rootfs apt-get autoremove --purge -y
    chroot "$builddir"/psec-container-debian/rootfs apt-get autoclean
    chroot "$builddir"/psec-container-debian/rootfs rm -rf /tmp/*
    chroot "$builddir"/psec-container-debian/rootfs rm -rf /var/tmp/*
    chroot "$builddir"/psec-container-debian/rootfs rm -rf /usr/share/doc/*
    chroot "$builddir"/psec-container-debian/rootfs rm -rf /usr/share/man/*
    chroot "$builddir"/psec-container-debian/rootfs rm -rf /usr/share/info/*
    chroot "$builddir"/psec-container-debian/rootfs rm -rf /usr/share/locale/*

    tar cjf -e "sys" "$builddir/$pkgname".tar.bz2 -C "$builddir"/psec-container-debian --exclude "rootfs/sys" --exclude "rootfs/proc" --exclude "rootfs/dev" .
}

package() {    
    # Tar container
    echo Create the package
    mv "$pkgdir/$pkgname".tar.bz2 "$pkgdir"/
}
