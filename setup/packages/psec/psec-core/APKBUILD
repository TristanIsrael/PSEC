# Contributor:
# Maintainer: Tristan Israël <tristan.israel@alefbet.net>
pkgname=psec-core
pkgver=1.0
pkgrel=1
pkgdesc="PSEC - Core of the system"
url="https://www.alefbet.net/"
arch="noarch"
license="MIT"
depends="cdrkit psec-lib"
makedepends=""
builddir="$srcdir/$pkgname-$pkgver"
install="$pkgname.post-install"
checkdepends=""
install=""
subpackages=""
replaces="alpine-baselayout-data"
options="!check"  # no tests provided

sources="constants.sh
setup-alpine-repositories.sh
setup-domu-template.sh
setup-xen-environment.sh
create-local-alpine-repository.sh
generate-pgp-keys.sh
reindex-and-sign-repository.sh
create-domu.sh"

PSEC_CONFDIR="$pkgdir/etc/psec"
PSEC_ROOTDIR="$pkgdir/usr/local/psec"
PSEC_BINDIR="$PSEC_ROOTDIR/bin"

build() {
    echo "Create default overlay for User Domains"
    cd "$startdir"/domu_apkovl.tmpl
    mkdir -p "$builddir"
    tar czf "$builddir"/domu.apkovl.tar.gz --exclude '.DS_Store' etc/ 
}

check() {
    nb_fichiers=`tar tvzf $builddir/domu.apkovl.tar.gz | wc -l`
    if [ $nb_fichiers != 32 ]; then 
        echo "Le nombre de fichiers dans l'overlay domU est incorrect."
        echo "trouvés=$nb_fichiers, attendus=32"
        echo "Vérifiez le dossier domu_apkvol.tmpl"
        return 1
    fi
}

package() {
    # Alpine overlay for DomUs
    install -D -m644 "$builddir"/domu.apkovl.tar.gz "$pkgdir"/usr/local/psec/system/domu.apkovl.tar.gz

    install -D -m644 "$srcdir"/constants.sh "$PSEC_CONFDIR"/constants.sh
    install -D -m644 "$srcdir"/setup-alpine-repositories.sh "$PSEC_BINDIR"/setup-alpine-repositories.sh
    install -D -m644 "$srcdir"/setup-domu-template.sh "$PSEC_BINDIR"/setup-domu-template.sh
    install -D -m644 "$srcdir"/create-local-alpine-repository.sh "$PSEC_BINDIR"/create-local-alpine-repository.sh
    install -D -m644 "$srcdir"/generate-pgp-keys.sh "$PSEC_BINDIR"/generate-pgp-keys.sh
    install -D -m644 "$srcdir"/create-domu.sh "$PSEC_BINDIR"/create-domu.sh
    install -D -m644 "$srcdir"/reindex-and-sign-repository.sh "$PSEC_BINDIR"/reindex-and-sign-repository.sh
    install -D -m644 "$srcdir"/setup-xen-environment.sh "$PSEC_BINDIR"/setup-xen-environment.sh

    install -D -m644 "$srcdir"/fstab "$pkgdir/etc/fstab"
    install -D -m644 "$srcdir"/modules "$pkgdir/etc/modules"

    install -D -m644 "$srcdir"/sys-usb.conf "$PSEC_CONFDIR/xen"
}