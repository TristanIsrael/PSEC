# Contributor:
# Maintainer: Tristan Israël <tristan.israel@alefbet.net>
pkgname=psec-core
pkgver=1.0
pkgrel=1
pkgdesc="PSEC - Core of the system"
url="https://www.alefbet.net/"
arch="noarch"
license="MIT"
depends="openrc cdrkit psec-lib xen xen-hypervisor xen-qemu xen-qemu-openrc abuild pciutils xorg-server xrandr font-terminus gtk+3.0 sdl2 sdl2_image mosquitto mosquitto-openrc mosquitto-clients socat"
makedepends=""
builddir="$srcdir/$pkgname-$pkgver"
install="$pkgname.post-install $pkgname.post-deinstall"
checkdepends=""
subpackages=""
replaces="alpine-baselayout-data mosquitto"
options="!check"  # no tests provided

source="
init/attach-pci-devices.initd
init/psec-core-controller.initd
init/setup-pci.initd
init/splash.initd
init/start-domains.initd
init/start-x.initd
init/create-mqtt-tunnels.initd

scripts/create-local-alpine-repository.sh
scripts/finish-core-init.sh
scripts/generate-pgp-keys.sh
scripts/provision-domain.sh
scripts/reindex-and-sign-repository.sh
scripts/setup-alpine-repositories.sh
scripts/setup-pci-usb-controllers.sh 
scripts/setup-pci-vga-controller.sh
scripts/setup-xen-environment.sh
scripts/get-sys-gui-domid.sh
scripts/post-install.sh
scripts/show-logs.sh

conf/constants.sh
conf/psec.conf
conf/10-energy-saving.conf
conf/topology.json
conf/mosquitto.conf

python/rotate-screen.py
python/create-domains.py
python/psec-core-controller.py
python/write-screen-information-to-xenstore.py
python/generate-x-config.py
python/get-total-memory.py
python/create-mqtt-tunnels.py

boot/Splash_800_1280.ppm
"

PSEC_CONFDIR="etc/psec"
PSEC_ROOTDIR="usr/lib/psec"
PSEC_BINDIR="$PSEC_ROOTDIR/bin"

build() {
    echo "Create default overlay for User Domains"
    cd "$startdir"/domu_apkovl.tmpl
    mkdir -p "$builddir"
    tar czf "$builddir"/domu.apkovl.tar.gz --exclude '.DS_Store' etc/ 
}

check() {
    nb_fichiers=`tar tvzf $builddir/domu.apkovl.tar.gz | wc -l`
    if [ $nb_fichiers != 32 ]; then 
        echo "Le nombre de fichiers dans l'overlay domU est incorrect."
        echo "trouvés=$nb_fichiers, attendus=32"
        echo "Vérifiez le dossier domu_apkvol.tmpl"
        return 1
    fi
}

package() {
    # Alpine overlay for DomUs
    install -D -m644 "$builddir"/domu.apkovl.tar.gz "$pkgdir"/usr/lib/psec/system/domu.apkovl.tar.gz

    install -D -m644 "$srcdir"/constants.sh "$pkgdir/$PSEC_CONFDIR"/constants.sh
    install -D -m644 "$srcdir"/create-domains.py "$pkgdir/$PSEC_BINDIR"/create-domains.py
    install -D -m755 "$srcdir"/provision-domain.sh "$pkgdir/$PSEC_BINDIR"/provision-domain.sh
    install -D -m755 "$srcdir"/create-local-alpine-repository.sh "$pkgdir/$PSEC_BINDIR"/create-local-alpine-repository.sh
    install -D -m755 "$srcdir"/generate-pgp-keys.sh "$pkgdir/$PSEC_BINDIR"/generate-pgp-keys.sh    
    install -D -m755 "$srcdir"/reindex-and-sign-repository.sh "$pkgdir/$PSEC_BINDIR"/reindex-and-sign-repository.sh
    install -D -m755 "$srcdir"/setup-alpine-repositories.sh "$pkgdir/$PSEC_BINDIR"/setup-alpine-repositories.sh        
    install -D -m755 "$srcdir"/setup-pci-usb-controllers.sh "$pkgdir/$PSEC_BINDIR"/setup-pci-usb-controllers.sh 
    install -D -m755 "$srcdir"/setup-pci-vga-controller.sh "$pkgdir/$PSEC_BINDIR"/setup-pci-vga-controller.sh
    install -D -m755 "$srcdir"/setup-xen-environment.sh "$pkgdir/$PSEC_BINDIR"/setup-xen-environment.sh
    install -D -m755 "$srcdir"/finish-core-init.sh "$pkgdir/$PSEC_BINDIR"/finish-core-init.sh
    install -D -m755 "$srcdir"/psec-core-controller.py "$pkgdir/$PSEC_BINDIR"/psec-core-controller.py
    install -D -m755 "$srcdir"/create-mqtt-tunnels.py "$pkgdir/$PSEC_BINDIR"/create-mqtt-tunnels.py
    
    install -D -m755 "$srcdir"/attach-pci-devices.initd "$pkgdir"/etc/init.d/attach-pci-devices
    install -D -m755 "$srcdir"/setup-pci.initd "$pkgdir"/etc/init.d/setup-pci
    install -D -m755 "$srcdir"/splash.initd "$pkgdir"/etc/init.d/splash
    install -D -m755 "$srcdir"/start-domains.initd "$pkgdir"/etc/init.d/start-domains
    install -D -m755 "$srcdir"/psec-core-controller.initd "$pkgdir"/etc/init.d/psec-core-controller

    install -D -m644 "$srcdir"/psec.conf "$pkgdir/etc/modules-load.d/psec.conf"

    #install -D -m644 "$srcdir"/sys-usb.conf "$pkgdir/$PSEC_CONFDIR/xen/sys-usb.conf"
    install -D -m644 "$srcdir"/topology.json "$pkgdir/$PSEC_CONFDIR"/topology.json

    install -D -m755 "$srcdir"/start-x.initd "$pkgdir"/etc/init.d/start-x
    install -D -m644 "$srcdir"/rotate-screen.py "$pkgdir/$PSEC_BINDIR"/rotate-screen.py
    install -D -m644 "$srcdir"/generate-x-config.py "$pkgdir/$PSEC_BINDIR"/generate-x-config.py
    #install -D -m755 "$srcdir"/connect-to-gui.initd "$pkgdir"/etc/init.d/connect-to-gui

    install -D -m755 "$srcdir"/post-install.sh "$pkgdir/$PSEC_BINDIR"/post-install.sh
    install -D -m755 "$srcdir"/get-sys-gui-domid.sh "$pkgdir/$PSEC_BINDIR"/get-sys-gui-domid.sh
    install -D -m644 "$srcdir"/write-screen-information-to-xenstore.py "$pkgdir/$PSEC_BINDIR"/write-screen-information-to-xenstore.py
    install -D -m755 "$srcdir"/show-logs.sh "$pkgdir/$PSEC_BINDIR"/show-logs.sh

    install -D -m644 "$srcdir"/get-total-memory.py "$pkgdir/$PSEC_BINDIR"/get-total-memory.py

    install -D -m644 "$srcdir"/10-energy-saving.conf "$pkgdir"/etc/X11/xorg.conf.d/10-energy-saving.conf

    install -D -m644 "$srcdir"/Splash_800_1280.ppm "$pkgdir"/boot/Splash_800_1280.ppm

    # Mosquitto
    install -D -m644 "$srcdir"/mosquitto.conf "$pkgdir"/etc/mosquitto/mosquitto.conf
    install -D -m755 "$srcdir"/create-mqtt-tunnels.initd "$pkgdir"/etc/init.d/create-mqtt-tunnels.sh

}
