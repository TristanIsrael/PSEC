# Contributor:
# Maintainer: Tristan IsraÃ«l <tristan.israel@alefbet.net>
pkgname=safecor-diag
pkgver=1.1
pkgrel=0
pkgdesc="Safecor - Diagnostic tool"
url="https://www.alefbet.net/"
arch="noarch"
license="MIT"
depends="python3 py3-pyside6 py3-py-cpuinfo py3-psutil fontconfig freetype font-roboto udev udev-init-scripts xen xen-hypervisor"
makedepends="python3-dev py3-build py3-installer git"
builddir="$srcdir/$pkgname-$pkgver"
checkdepends=""
install="$pkgname.post-install"
subpackages=""
replaces="alpine-baselayout alpine-baselayout-data openrc"
options="!check"  # no tests provided
gitbranch="main"
source="
$pkgname.zip::https://github.com/TristanIsrael/Safecor/archive/refs/heads/$gitbranch.zip
start-debug.sh
motd
rc.conf
inittab
"

prepare() {
    default_prepare
}

build() {
    cd "$gitrepo-$gitbranch/python/diag"
    python3 -m build
}

package() {
    echo "srcdir=$srcdir"
    ls $srcdir
    mkdir -p "$pkgdir/usr/lib/safecor"
    cd "$srcdir/$gitrepo-$gitbranch/python/diag/dist"    
    tar xvzf *.tar.gz -C "$pkgdir/usr/lib/safecor"
    cd "$pkgdir/usr/lib/safecor"
    ln -s "diag-$pkgver" diag    

    #install -D -m755 "$srcdir"/diag.initd "$pkgdir/etc/init.d/diag"
    #install -D -m755 "$srcdir"/debug.initd "$pkgdir/etc/init.d/debug"
    install -D -m755 "$srcdir"/start-debug.sh "$pkgdir/usr/lib/safecor/bin/start-debug.sh"
    install -D -m755 "$srcdir"/motd "$pkgdir/etc/motd"
    install -D -m755 "$srcdir"/inittab "$pkgdir/etc/inittab"
    install -D -m644 "$srcdir"/rc.conf "$pkgdir/etc/rc.conf"
}
