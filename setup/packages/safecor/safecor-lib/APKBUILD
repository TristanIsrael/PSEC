# Contributor:
# Maintainer: Tristan Isra..l <tristan.israel@alefbet.net>
pkgname=safecor-lib
pkgver=1.2
pkgrel=0
pkgdesc="Safecor - Python library"
url="https://www.alefbet.net/"
arch="noarch"
license="MIT"
depends="python3 py3-evdev py3-pyserial py3-paho-mqtt2 py3-udev py3-msgpack py3-psutil dmidecode"
makedepends="python3-dev py3-build py3-installer py3-pip"
builddir="$srcdir/$pkgname-$pkgver"
checkdepends=""
install=""
subpackages=""
replaces=""
options=""  # no tests provided
source="
$pkgname.zip::https://github.com/TristanIsrael/Safecor/archive/refs/heads/$gitbranch.zip
"

CONFDIR="$pkgdir/etc/safecor"
ROOTDIR="$pkgdir/usr/lib/safecor"
BINDIR="$ROOTDIR/bin"

prepare() {
    default_prepare
    #mkdir -p "$builddir"
    #echo "Uncompress source files"
    #unzip $pkgname.zip -d "$builddir"    
}

build() {
    cd "$gitrepo-$gitbranch/python/lib"
    python3 -m build
}

package() {
    cd "src/$gitrepo-$gitbranch/python/lib/dist"
    python3 -m installer --destdir=$pkgdir safecor-*-py3-none-any.whl
}

check() {
    cd "$gitrepo-$gitbranch/python/lib/src/safecor"

    python3 -m pip install --upgrade pip
    python3 -m venv .venv
    source .venv/bin/activate

    python3 -m pip install -r requirements.txt
    python3 -m pip install black ruff mypy coverage bandit pip-audit

    echo "Check format"
    black --check .

    echo "Lint"
    ruff check .

    echo "Check type"
    mypy .

    echo "Security audit"
    bandit -r .
    pip-audit

    echo "Unittests and coverage"
    cd "$gitrepo-$gitbranch/python/lib/src"
    coverage run --omit="tests/*,*/tests/*" -m unittest discover -s tests -v
    coverage report --fail-under=50
}